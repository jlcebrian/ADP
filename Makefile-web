CC = emcc
CXX = em++
CPPFLAGS += -flto=full -Os -sUSE_SDL=2 \
	    -fno-rtti -s DISABLE_EXCEPTION_CATCHING 
LDFLAGS += -sUSE_SDL=2 -lSDL -lidbfs.js -sFORCE_FILESYSTEM \
	--shell-file shell.html  \
	-sEXPORTED_RUNTIME_METHODS=['ccall','cwrap'] \
	-sEXPORTED_FUNCTIONS=_main,_KeyPressed
	
CPPFLAGS += -Iinclude -D_STDCLIB -D_UNIX -D_WEB -D_DEBUGPRINT
CPPFLAGS += -Dstricmp=strcasecmp -Dstrnicmp=strncasecmp 
CPPFLAGS += -g -DVERSION="ALPHA `date +%Y%m%d`"

TOOL_SRCS = dim_adf dim_cpc dim_fat dim dmg_edit img

DIRS = src-common/ src-unix/ src-sdl/
VPATH = $(DIRS) src-tools/

SRCS := \
	player.cpp \
	ddb.cpp \
	ddb_char.cpp \
	ddb_data.cpp \
	ddb_dump.cpp \
	ddb_inp.cpp \
	ddb_pal.cpp \
	ddb_play.cpp \
	ddb_run.cpp \
	ddb_scr.cpp \
	ddb_vid.cpp \
	dmg.cpp \
	dmg_cach.cpp \
	dmg_imgc.cpp \
	dmg_imgp.cpp \
	dmg_rlec.cpp \
	dmg_univ.cpp \
	os_lib.cpp \
	os_mem.cpp \
	scrfile.cpp \
	video.cpp \
	error.cpp \
	files.cpp

OBJS := $(addprefix obj/web/,$(patsubst %.cpp,%.o,$(SRCS)))

-include $(OBJS:.o=.d)

GAMES = original chichen templos espacial jabato cozumel

all: \
	out/web/original/index.html \
	out/web/jabato/index.html \
	out/web/espacial/index.html \
	out/web/templos/index.html \
	out/web/cozumel/index.html \
	out/web/chichen/index.html 

out/web/original/index.html: $(OBJS)
	$(CXX) -o $@ $^ $(LDFLAGS) --embed-file out/original@/data/ 
out/web/jabato/index.html: $(OBJS)
	$(CXX) -o $@ $^ $(LDFLAGS) --embed-file out/jabato@/data/ 
out/web/cozumel/index.html: $(OBJS)
	$(CXX) -o $@ $^ $(LDFLAGS) --embed-file out/cozumel@/data/ 
out/web/espacial/index.html: $(OBJS)
	$(CXX) -o $@ $^ $(LDFLAGS) --embed-file out/espacial@/data/ 
out/web/templos/index.html: $(OBJS)
	$(CXX) -o $@ $^ $(LDFLAGS) --embed-file out/templos@/data/ 
out/web/chichen/index.html: $(OBJS)
	$(CXX) -o $@ $^ $(LDFLAGS) --embed-file out/chichen@/data/ 

clean:
	rm -f out/web/*/index.* obj/web/*.o

$(OBJS) : obj/web/%.o : %.cpp
	$(info Compiling $<)
	@$(CC) $(CPPFLAGS) -c -o $@ $(CURDIR)/$<
