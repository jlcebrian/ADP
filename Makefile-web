VERSION ?= BETA0.1

CC = emcc
CXX = em++
CPPFLAGS += -flto=full -Os -sUSE_SDL=2 \
	    -fno-rtti -s DISABLE_EXCEPTION_CATCHING 
LDFLAGS += -sUSE_SDL=2 -lSDL -lidbfs.js -sFORCE_FILESYSTEM \
	--shell-file shell.html  \
	-sEXPORTED_RUNTIME_METHODS=['ccall','cwrap'] \
	-sEXPORTED_FUNCTIONS=_main,_KeyPressed
	
CPPFLAGS += -Iinclude -D_STDCLIB -D_UNIX -D_WEB -D_DEBUGPRINT
CPPFLAGS += -Dstricmp=strcasecmp -Dstrnicmp=strncasecmp 
CPPFLAGS += -g -DVERSION=$(VERSION)

TOOL_SRCS = dim_adf dim_cpc dim_fat dim dmg_edit img

DIRS = src-common/ src-sdl/ src-unix/
VPATH = $(DIRS) src-tools/

SRCS := \
	player.cpp \
	ddb.cpp \
	ddb_data.cpp \
	ddb_dump.cpp \
	ddb_inp.cpp \
	ddb_pal.cpp \
	ddb_play.cpp \
	ddb_run.cpp \
	ddb_scr.cpp \
	ddb_vid.cpp \
	dmg.cpp \
	dmg_cga.cpp \
	dmg_ega.cpp \
	dmg_cach.cpp \
	dmg_imgc.cpp \
	dmg_imgp.cpp \
	dmg_rlec.cpp \
	dmg_univ.cpp \
	os_lib.cpp \
	os_mem.cpp \
	os_char.cpp \
	scrfile.cpp \
	video.cpp \
	error.cpp \
	files.cpp

OBJS := $(addprefix obj/web/,$(patsubst %.cpp,%.o,$(SRCS)))

-include $(OBJS:.o=.d)

GAMES = $(notdir $(wildcard web-games/*))
GAMEDIRS = $(patsubst %,out\web\\%,$(GAMES))

all: out/web/adp/index.html $(patsubst %,out/web/%/index.html,$(GAMES)) 

out/web/adp/index.html: $(OBJS) shell.html
	$(info Building adp)
ifeq ($(OS), Windows_NT)
	@IF NOT EXIST "out\web\adp" mkdir out\web\adp
else
	@mkdir -o out/web/adp
endif
	@$(CXX) -o $@ $(OBJS) $(LDFLAGS) 

out/web/%/index.html: $(OBJS) shell.html
	$(info Building $*)
ifeq ($(OS), Windows_NT)
	@IF NOT EXIST "out\web\$*" mkdir out\web\$*
else
	@mkdir -o out/web/$*
endif
	@$(CXX) -o $@ $(OBJS) $(LDFLAGS) --preload-file web-games/$*@/data/ 

clean:
ifeq ($(OS), Windows_NT)
	-rd /S /Q $(GAMEDIRS)
	-del obj\web\*.o
else
	rm -f out/web/*/index.* obj/web/*.o
endif

$(OBJS) : obj/web/%.o : %.cpp
	$(info Compiling $<)
	@$(CC) $(CPPFLAGS) -c -o $@ $(CURDIR)/$<
